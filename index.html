<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trip Outfit Board</title>
<style>
  html,body{
    margin:0;height:100%;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:#fff;-webkit-user-select:none;user-select:none;touch-action:none;
  }
  .app{display:flex;flex-direction:column;height:100vh;padding:10px;box-sizing:border-box;}
  header{
    display:flex;flex-wrap:wrap;align-items:center;gap:10px;
    padding-bottom:10px;border-bottom:1px solid #eee;
  }
  select,button{
    padding:8px 12px;border-radius:6px;border:1px solid #a18a7a;
    font-size:15px;background:#a18a7a;color:#fff;cursor:pointer;
    transition:background .2s,transform .1s;
  }
  button:hover{background:#1565c0;}
  button:active{transform:scale(.98);}

  #board{
    flex:1;position:relative;background:#fff;border:1px solid #eee;
    border-radius:8px;overflow:hidden;margin-top:10px;
  }

  .photo{
    position:absolute;cursor:grab;user-select:none;
    border:2px solid transparent;border-radius:6px;
  }
  .photo.selected{border-color:#ffeb3b;}
  .photo img{display:block;max-width:none;height:auto;border-radius:6px;pointer-events:none;}

  .resize-handle{
    position:absolute;bottom:-6px;right:-6px;width:10px;height:10px;
    background:#fff;border-radius:50%;cursor:se-resize;border:1px solid #000;
  }

  /* Popup */
  .popup{
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:1000;
  }
  .popup-content{
    background:#fff;padding:20px;border-radius:12px;
    box-shadow:0 2px 12px rgba(0,0,0,0.2);
    display:flex;flex-direction:column;gap:10px;width:260px;text-align:center;
  }
  .popup-content button{
    width:100%;background:#a18a7a;border:none;padding:10px;border-radius:8px;
    font-size:15px;color:white;
  }
  .popup-content button:hover{background:#1565c0;}
</style>
</head>

<body>
<div class="app">

  <header>
    <label for="daySelect">Select Day:</label>
    <select id="daySelect"></select>

    <button id="addDayBtn">+ Add Day</button>
    <button id="insertPhotoBtn">Insert Photo(s)</button>
    <button id="deletePhotoBtn">Delete Selected</button>

    <!-- SAVE MANUAL -->
    <button id="saveLocalBtn">Save Local</button>

    <button id="resetBtn">Reset</button>

    <input id="fileInput" type="file" accept="image/*" multiple style="display:none"/>
    <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none"/>
  </header>

  <div id="board"></div>
</div>

<!-- Popup -->
<div id="photoPopup" class="popup" style="display:none">
  <div class="popup-content">
    <h3>Select Image Source</h3>
    <button id="libraryBtn">üìÅ Photo Library</button>
    <button id="cameraBtn">üì∑ Take Photo</button>
    <button id="fileBtn">üóÇÔ∏è Choose File</button>
    <button id="pasteBtn">üìã Paste Image</button>
    <button id="closePopupBtn" style="background:#ccc;color:#000;">Cancel</button>
  </div>
</div>

<script>
(function(){
  /* --------------------------------------------
       STORAGE KEYS (pentru varianta B)
  -------------------------------------------- */
  const STORAGE_KEY = 'trip_outfit_v3_manual';
  const STORAGE_DAY_KEY = 'trip_outfit_current_day';

  let data = {};
  let currentDay = 'Day 1';

  let dragged = null, startX=0, startY=0, origX=0, origY=0;
  let resizing = null, startW=0;
  let touchStartTime = 0;

  const daySelect = document.getElementById('daySelect');
  const addDayBtn = document.getElementById('addDayBtn');
  const insertPhotoBtn = document.getElementById('insertPhotoBtn');
  const deletePhotoBtn = document.getElementById('deletePhotoBtn');
  const saveLocalBtn = document.getElementById('saveLocalBtn');
  const resetBtn = document.getElementById('resetBtn');
  const fileInput = document.getElementById('fileInput');
  const cameraInput = document.getElementById('cameraInput');
  const board = document.getElementById('board');
  const popup = document.getElementById('photoPopup');
  const libraryBtn = document.getElementById('libraryBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const fileBtn = document.getElementById('fileBtn');
  const pasteBtn = document.getElementById('pasteBtn');
  const closePopupBtn = document.getElementById('closePopupBtn');

  function createId(){return 'id_'+Math.random().toString(36).slice(2,9);}
  function ensureDay(d){ if(!data[d]) data[d] = []; }

  /* --------------------------------------------
       RENDER DAYS + BOARD
  -------------------------------------------- */
  function renderDays(){
    daySelect.innerHTML='';
    Object.keys(data).forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d; opt.textContent=d;
      if(d===currentDay) opt.selected=true;
      daySelect.appendChild(opt);
    });
  }

  function renderBoard(){
    board.innerHTML='';
    ensureDay(currentDay);

    data[currentDay].forEach(p=>{
      const el=document.createElement('div');
      el.className='photo';
      el.dataset.id=p.id;
      el.style.left=p.x+'px';
      el.style.top=p.y+'px';

      const img=document.createElement('img');
      img.src=p.src;
      if(p.width) img.style.width = p.width + 'px';
      el.appendChild(img);

      const rh=document.createElement('div');
      rh.className='resize-handle';
      el.appendChild(rh);

      // Drag events
      el.addEventListener('mousedown',startDrag);
      el.addEventListener('touchstart',startDragTouch,{passive:false});

      // Resize
      rh.addEventListener('mousedown',startResize);
      rh.addEventListener('touchstart',startResizeTouch,{passive:false});

      board.appendChild(el);
    });
  }

  /* --------------------------------------------
      DRAGGING
  -------------------------------------------- */
  function startDrag(e){
    if(e.target.classList.contains('resize-handle'))return;
    if(e.button!==0)return;

    dragged = e.currentTarget;
    const rect = dragged.getBoundingClientRect();
    const brect = board.getBoundingClientRect();

    startX = e.clientX;
    startY = e.clientY;
    origX = rect.left - brect.left;
    origY = rect.top - brect.top;

    document.addEventListener('mousemove',onDrag);
    document.addEventListener('mouseup',endDrag);
  }

  function onDrag(e){
    if(!dragged)return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    dragged.style.left = origX + dx + 'px';
    dragged.style.top  = origY + dy + 'px';
  }

  function endDrag(){
    savePosition();
    cleanupDrag();
  }

  /* --------------------------------------------
      DRAG TOUCH
  -------------------------------------------- */
  function startDragTouch(e){
    if(e.target.classList.contains('resize-handle'))return;
    e.preventDefault();

    dragged = e.currentTarget;
    touchStartTime = Date.now();

    const t = e.touches[0];
    const rect = dragged.getBoundingClientRect();
    const brect = board.getBoundingClientRect();

    startX = t.clientX;
    startY = t.clientY;
    origX = rect.left - brect.left;
    origY = rect.top - brect.top;

    document.addEventListener('touchmove',onDragTouch,{passive:false});
    document.addEventListener('touchend',endDragTouch);
  }

  function onDragTouch(e){
    if(!dragged)return;
    e.preventDefault();

    const t = e.touches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;

    dragged.style.left = origX + dx + 'px';
    dragged.style.top  = origY + dy + 'px';
  }

  function endDragTouch(){
    savePosition();
    cleanupDrag();
  }

  function cleanupDrag(){
    document.removeEventListener('mousemove',onDrag);
    document.removeEventListener('mouseup',endDrag);
    document.removeEventListener('touchmove',onDragTouch);
    document.removeEventListener('touchend',endDragTouch);
  }

  /* --------------------------------------------
      RESIZE
  -------------------------------------------- */
  function startResize(e){
    e.stopPropagation();
    resizing = e.target.parentElement;

    const img = resizing.querySelector('img');
    const rect = img.getBoundingClientRect();

    startW = rect.width;
    startX = e.clientX;

    document.addEventListener('mousemove',onResize);
    document.addEventListener('mouseup',endResize);
  }

  function onResize(e){
    if(!resizing)return;
    const img = resizing.querySelector('img');
    const dx = e.clientX - startX;
    img.style.width = (startW + dx) + 'px';
  }

  function endResize(){
    saveSize(resizing);
    resizing=null;
    document.removeEventListener('mousemove',onResize);
    document.removeEventListener('mouseup',endResize);
  }

  /* --------------------------------------------
      RESIZE TOUCH
  -------------------------------------------- */
  function startResizeTouch(e){
    e.preventDefault(); e.stopPropagation();
    resizing = e.target.parentElement;

    const img = resizing.querySelector('img');
    const rect = img.getBoundingClientRect();

    startW = rect.width;
    const t = e.touches[0];
    startX = t.clientX;

    document.addEventListener('touchmove',onResizeTouch,{passive:false});
    document.addEventListener('touchend',endResizeTouch);
  }

  function onResizeTouch(e){
    if(!resizing)return;
    e.preventDefault();

    const t = e.touches[0];
    const dx = t.clientX - startX;

    const img = resizing.querySelector('img');
    img.style.width = (startW + dx) + 'px';
  }

  function endResizeTouch(){
    saveSize(resizing);
    resizing=null;
    document.removeEventListener('touchmove',onResizeTouch);
    document.removeEventListener('touchend',endResizeTouch);
  }

  /* --------------------------------------------
      SAVE POS/ SIZE to DATA (NOT STORAGE)
      (Manual saving only when user presses SAVE)
  -------------------------------------------- */
  function savePosition(){
    if(dragged){
      const id = dragged.dataset.id;
      const ph = data[currentDay].find(p=>p.id===id);
      if(ph){
        const rect = dragged.getBoundingClientRect();
        const brect = board.getBoundingClientRect();
        ph.x = rect.left - brect.left;
        ph.y = rect.top - brect.top;
      }
    }
  }

  function saveSize(el){
    const id = el.dataset.id;
    const ph = data[currentDay].find(p=>p.id===id);
    if(ph){
      const img = el.querySelector('img');
      ph.width = parseFloat(img.style.width) || img.width;
    }
  }

  /* --------------------------------------------
      POPUP
  -------------------------------------------- */
  insertPhotoBtn.addEventListener('click',()=>popup.style.display='flex');
  closePopupBtn.addEventListener('click',()=>popup.style.display='none');

  libraryBtn.addEventListener('click',()=>{fileInput.click();popup.style.display='none';});
  cameraBtn.addEventListener('click',()=>{cameraInput.click();popup.style.display='none';});
  fileBtn.addEventListener('click',()=>{fileInput.click();popup.style.display='none';});

  /* --------------------------------------------
      FILE HANDLING
  -------------------------------------------- */
  async function handleFiles(files){
    for(const f of files){
      const r=new FileReader();
      await new Promise(res=>{
        r.onload=()=>{
          data[currentDay].push({
            id:createId(),
            src:r.result,
            x:40,
            y:40,
            width:150,
            name:f.name
          });
          res();
        };
        r.readAsDataURL(f);
      });
    }
    renderBoard();
  }

  fileInput.addEventListener('change',e=>{
    handleFiles(e.target.files);
    e.target.value='';
  });

  cameraInput.addEventListener('change',e=>{
    handleFiles(e.target.files);
    e.target.value='';
  });

  /* --------------------------------------------
      PASTE IMAGE
  -------------------------------------------- */
  pasteBtn.addEventListener('click',async()=>{
    popup.style.display='none';
    try{
      const items=await navigator.clipboard.read();
      for(const item of items){
        for(const type of item.types){
          if(type.startsWith('image/')){
            const blob=await item.getType(type);
            const r=new FileReader();
            await new Promise(res=>{
              r.onload=()=>{
                data[currentDay].push({
                  id:createId(),
                  src:r.result,
                  x:40,
                  y:40,
                  width:150,
                  name:'Pasted Image'
                });
                res();
              };
              r.readAsDataURL(blob);
            });
          }
        }
      }
      renderBoard();
    }catch(err){
      alert("No image in clipboard or unsupported.");
    }
  });

  /* --------------------------------------------
      ADD DAY
  -------------------------------------------- */
  addDayBtn.addEventListener('click',()=>{
    const n = Object.keys(data).length + 1;
    const name = 'Day ' + n;

    data[name] = [];
    currentDay = name;

    renderDays();
    renderBoard();
  });

  /* --------------------------------------------
      SELECT DAY
  -------------------------------------------- */
  daySelect.addEventListener('change',()=>{
    currentDay = daySelect.value;
  });

  /* --------------------------------------------
      DELETE PHOTO
  -------------------------------------------- */
  deletePhotoBtn.addEventListener('click',()=>{
    const selected = [...board.querySelectorAll('.photo.selected')];
    if(!selected.length) return alert('Select a photo first.');
    if(!confirm('Delete selected photo(s)?'))return;

    const ids = selected.map(el=>el.dataset.id);
    data[currentDay] = data[currentDay].filter(p=>!ids.includes(p.id));

    renderBoard();
  });

  /* --------------------------------------------
      SAVE MANUAL
  -------------------------------------------- */
  saveLocalBtn.addEventListener('click',()=>{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    localStorage.setItem(STORAGE_DAY_KEY, currentDay);

    saveLocalBtn.textContent = "Saved ‚úì";
    setTimeout(()=>saveLocalBtn.textContent="Save Local",1000);
  });

  /* --------------------------------------------
      RESET
  -------------------------------------------- */
  resetBtn.addEventListener('click',()=>{
    if(confirm('Reset everything?')){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_DAY_KEY);
      location.reload();
    }
  });

  /* --------------------------------------------
      LOAD FROM STORAGE
  -------------------------------------------- */
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    const savedDay = localStorage.getItem(STORAGE_DAY_KEY);

    if(raw){
      data = JSON.parse(raw);
      currentDay = savedDay || Object.keys(data)[0] || "Day 1";
    } else {
      data = {
        "Day 1":[]
      };
      currentDay = "Day 1";
    }
  }

  /* --------------------------------------------
      INIT
  -------------------------------------------- */
  load();
  renderDays();
  renderBoard();
})();
</script>

</body>
</html>
